"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _event=require("./event.js"),_event2=_interopRequireDefault(_event),_util=require("./util.js"),_util2=_interopRequireDefault(_util),PAGE_EVENT=["onLoad","onReady","onShow","onHide","onUnload","onPullDownRefresh","onReachBottom","onShareAppMessage","onPageScroll","onTabItemTap"],APP_EVENT=["onLaunch","onShow","onHide","onError"],$bindEvt=function e(t,n,o){n.$prefix=_util2.default.camelize(o||""),Object.getOwnPropertyNames(n.components||{}).forEach(function(a){var r=n.components[a],i=new r;i.$initMixins(),i.$name=a;var p=o?o+i.$name+"$":"$"+i.$name+"$";n.$com[a]=i,e(t,i,p)}),Object.getOwnPropertyNames(n.constructor.prototype||[]).forEach(function(e){"constructor"!==e&&-1===PAGE_EVENT.indexOf(e)&&(t[e]=function(){n.constructor.prototype[e].apply(n,arguments),n.$apply()})});var a=Object.getOwnPropertyNames(n.methods||[]);return n.$mixins.forEach(function(e){a=a.concat(Object.getOwnPropertyNames(e.methods||[]))}),a.forEach(function(e,o){t[n.$prefix+e]=function(t){for(var o=arguments.length,a=Array(o>1?o-1:0),r=1;r<o;r++)a[r-1]=arguments[r];var i=new _event2.default("system",this,t.type);i.$transfor(t);var p=[],c=0,s=void 0,f=void 0,u=void 0;if(t.currentTarget&&t.currentTarget.dataset){for(s=t.currentTarget.dataset;void 0!==s["wpy"+e.toLowerCase()+(f=String.fromCharCode(65+c++))];)p.push(s["wpy"+e.toLowerCase()+f]);void 0!==s.comIndex&&(u=s.comIndex)}if(void 0!==u){u=(""+u).split("-");for(var h=u.length,$=h;h-- >0;){$=h;for(var l=n;$-- >0;)l=l.$parent;l.$setIndex(u.shift())}}a=a.concat(p);var _=void 0,d=void 0,v=n.methods[e];return v&&(_=v.apply(n,a.concat(i))),n.$mixins.forEach(function(t){t.methods[e]&&(d=t.methods[e].apply(n,a.concat(i)))}),n.$apply(),v?_:d}}),t};exports.default={$createApp:function(e,t){var n={},o=new e;return this.$instance||(o.$init(this,t),this.$instance=o,this.$appConfig=t),2===arguments.length&&!0===arguments[1]&&(n.$app=o),o.$wxapp=getApp(),APP_EVENT=APP_EVENT.concat(t.appEvents||[]),PAGE_EVENT=PAGE_EVENT.concat(t.pageEvents||[]),APP_EVENT.forEach(function(e){n[e]=function(){for(var t=arguments.length,n=Array(t),a=0;a<t;a++)n[a]=arguments[a];var r=void 0;return!o.$wxapp&&(o.$wxapp=getApp()),o[e]&&(r=o[e].apply(o,n)),r}}),n},$createPage:function(e,t){var n=this,o={},a=new e;return"string"==typeof t&&(this.$instance.$pages["/"+t]=a),a.$initMixins(),("boolean"==typeof t&&t||3===arguments.length&&!0===arguments[2])&&(o.$page=a),o.onLoad=function(){for(var t=arguments.length,o=Array(t),r=0;r<t;r++)o[r]=arguments[r];a.$name=e.name||"unnamed",a.$init(this,n.$instance,n.$instance);var i=n.$instance.__prevPage__,p={};p.from=i||void 0,i&&Object.keys(i.$preloadData).length>0&&(p.preload=i.$preloadData,i.$preloadData={}),a.$prefetchData&&Object.keys(a.$prefetchData).length>0&&(p.prefetch=a.$prefetchData,a.$prefetchData={}),o.push(p),[].concat(a.$mixins,a).forEach(function(e){e.onLoad&&e.onLoad.apply(a,o)}),a.$apply()},o.onShow=function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];n.$instance.__prevPage__=a,[].concat(a.$mixins,a).forEach(function(e){e.onShow&&e.onShow.apply(a,t)});var r=getCurrentPages(),i=r[r.length-1].__route__,p=r[r.length-1].__wxWebviewId__;n.$instance.__wxWebviewId__!==p&&(a.$wxpage=this,n.$instance.__route__=i,n.$instance.__wxWebviewId__=p,[].concat(a.$mixins,a).forEach(function(e){e.onRoute&&e.onRoute.apply(a,t)})),a.$apply()},PAGE_EVENT.forEach(function(e){"onLoad"!==e&&"onShow"!==e&&(o[e]=function(){for(var t=arguments.length,n=Array(t),o=0;o<t;o++)n[o]=arguments[o];var r=void 0;return"onShareAppMessage"===e?(a[e]&&(r=a[e].apply(a,n)),r):([].concat(a.$mixins,a).forEach(function(t){t[e]&&t[e].apply(a,n)}),a.$apply(),r)})}),a.onShareAppMessage||delete o.onShareAppMessage,$bindEvt(o,a,"")}};